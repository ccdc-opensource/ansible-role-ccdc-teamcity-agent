---

- name: Install teamcityagent
  win_chocolatey:
    name: teamcityagent
    state: present
    allow_empty_checksums: true
    package_params: "serverUrl={{ teamcity_server_url }} agentName={{ inventory_hostname }} agentDir={{ teamcity_agent_root_directory }} serviceAccount=.\\{{ teamcity_agent_account }} serviceAccountPassword={{ teamcity_agent_account_password }}"
  when: "ansible_os_family == 'Windows'"

- name: Install jre8
  win_chocolatey:
    name: jre8
    state: present
  when: "ansible_os_family == 'Windows'"

- name: Remove generated service (we run this manually)
  win_service:
    name: "{{ inventory_hostname }} TeamCity Build Agent"
    state: absent
  when: "ansible_os_family == 'Windows'"

- name: add full control access to the build user
  win_acl:
    user: ".\{{teamcity_agent_account}}"
    path: "{{teamcity_agent_root_directory}}"
    rights: FullControl
    type: allow
    state: present
    inherit: ContainerInherit, ObjectInherit
  when: "ansible_os_family == 'Windows'"

- name: Create start cmd file
  win_template:
    src: start-tcagent.cmd.j2
    dest: "C:\Users\{{teamcity_agent_account}}\Desktop\start-tcagent.cmd"
  when: "ansible_os_family == 'Windows'"

- name: Create the ps1 file for accessing artefact
  win_template:
    src: tcagent.ps1.j2
    dest: "{{teamcity_agent_root_directory}}\connect-drives-and-start-tcagent.ps1"
  when: "ansible_os_family == 'Windows'"

- name: Create a shortcut to start the agent on login
  win_shortcut:
    src: 'C:\Users\{{teamcity_agent_account}}\Desktop\start-tcagent.cmd'
    dest: 'C:\Users\{{teamcity_agent_account}}\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup\StartTeamcityOnLogin.lnk'
    directory: 'C:\Users\{{teamcity_agent_account}}\Desktop\'
  when: "ansible_os_family == 'Windows'"
