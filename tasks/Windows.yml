---
# Install Windows Teamcity Agent

- name: "Ensure install directory exists (Windows)"  # noqa: name[template]
  ansible.windows.win_file:
    path: "{{ teamcity_agent_install_dir }}/{{ item.teamcity_agent_name }}"
    state: directory
  loop: "{{ teamcity_agents }}"

- name: "Check for existing configuration (Windows)"  # noqa: name[template]
  ansible.windows.win_stat:
    path: "{{ teamcity_agent_install_dir }}/{{ item.teamcity_agent_name }}/conf/buildAgent.properties"
  register: teamcity_agent_current_config_file
  loop: "{{ teamcity_agents }}"

- name: "Extract buildAgent.zip (Windows)"  # noqa: name[template]
  community.windows.win_unzip:
    src: "{{ teamcity_downloaded_buildagent_zip }}"
    dest: "{{ teamcity_agent_install_dir }}/{{ item.item.teamcity_agent_name }}"
    creates: "{{ teamcity_agent_install_dir }}/{{ item.item.teamcity_agent_name }}/bin/agent.bat"
  when:
    - not item.stat.exists
  loop: "{{ teamcity_agent_current_config_file.results }}"

- name: "Setup buildAgent.properties (Windows)"  # noqa: name[template]
  ansible.windows.win_template:
    src: "buildAgent.properties.j2"
    dest: "{{ teamcity_agent_install_dir }}/{{ item.teamcity_agent_name }}/conf/buildAgent.properties"
  loop: "{{ teamcity_agents }}"

- name: "Change ownership of all Build Agent files"  # noqa: name[template]
  ansible.windows.win_owner:
    path: "{{ teamcity_agent_install_dir }}"
    user: "{{ teamcity_build_username }}"
    recurse: true

- name: "Give {{ teamcity_build_username }} full control on files (Windows)"  # noqa: name[template]
  ansible.windows.win_acl:
    user: "{{ teamcity_build_username }}"
    path: "{{ teamcity_agent_install_dir }}"
    rights: FullControl
    type: allow
    state: present
    propagation: InheritOnly
    inherit: ContainerInherit, ObjectInherit

# Enable TC Agent Service
- name: "Setup wrapper.conf (Windows)"  # noqa: name[template]
  ansible.windows.win_template:
    src: "wrapper.conf.j2"
    dest: "{{ teamcity_agent_install_dir }}/{{ item.teamcity_agent_name }}/launcher/conf"
  loop: "{{ teamcity_agents }}"

- name: Install agent Service
  ansible.windows.win_shell: "{{ teamcity_agent_install_dir }}/{{ item.teamcity_agent_name }}/bin/service.install.bat"
  loop: "{{ teamcity_agents }}"

- name: Start agent service
  ansible.windows.win_shell: "{{ teamcity_agent_install_dir }}/{{ item.teamcity_agent_name }}/bin/service.start.bat"
  loop: "{{ teamcity_agents }}"
