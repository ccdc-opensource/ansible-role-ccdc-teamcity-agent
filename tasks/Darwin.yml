---
- homebrew_tap:
    name: AdoptOpenJDK/openjdk
    state: present

- name: Install adoptopenjdk for teamcity agent on MacOS
  homebrew_cask:
    name: adoptopenjdk11
    state: present

- name: "Create Agent directory"
  file:
    path: "{{ teamcity_agent_install_dir }}"
    state: directory
    mode: 0755

- name: "Download and extract Agent package"
  unarchive:
    src: "{{ teamcity_server_url }}/update/buildAgent.zip"
    dest: "{{ teamcity_agent_install_dir }}"
    remote_src: yes
    validate_certs: no

- name: "Save agent auth token"
  shell: "grep authorizationToken {{ teamcity_agent_install_dir }}/conf/buildAgent.properties | sed 's/authorizationToken=//g'"
  changed_when: no
  register: _teamcity_agent_token

- name: "Add TeamCity Agent configuration"
  template:
    src: "buildAgent.properties.j2"
    dest: "{{ teamcity_agent_install_dir }}/conf/buildAgent.properties"
    mode: 0644

- name: "Create log dir"
  file:
    path: "{{ teamcity_agent_install_dir }}/logs"
    state: directory
    mode: 0755

- name: "Create LaunchAgents directory"
  file:
    path: "{{ ansible_env.HOME }}/Library/LaunchAgents/"
    state: directory
    mode: 0755

- name: "Add TeamCity launchd service file"
  template:
    src: jetbrains.teamcity.BuildAgent.plist.j2
    dest: "{{ teamcity_agent_launchd_filename }}"
    mode: 0644

- name: "launchctl load buildagent"
  command: launchctl load "{{teamcity_agent_launchd_filename}}"
