---

- name: Insall Homebrew + openjdk
  ansible.builtin.include_role:
    name: geerlingguy.mac.homebrew
  vars:
    # This is overwritten by our group_vars (cpp.build-machines)
    homebrew_installed_packages:
      - openjdk@17
  when: not cpp_buildmachine
  
- name: setup java
  ansible.builtin.command: ln -sfn /usr/local/opt/openjdk@17/libexec/openjdk.jdk /Library/Java/JavaVirtualMachines/openjdk-17.jdk
  become: true

- name: Create teamcity agent install directory
  ansible.builtin.file:
    path: "{{ teamcity_agent_install_dir }}"
    state: directory
    mode: "0755"
    owner: "{{ teamcity_build_username }}"
    recurse: true

- name: Download Agent zip
  ansible.builtin.get_url:
    url: "{{ teamcity_buildagent_zip_url }}"
    dest: "{{ teamcity_downloaded_buildagent_zip }}"
    mode: 0775

- name: "Ensure LaunchAgents directory exists"
  ansible.builtin.file:
    path: /Users/{{ teamcity_build_username }}/Library/LaunchAgents/"
    state: directory
    mode: 0755
    owner: "{{ teamcity_build_username }}"

- name: Install Build Agents
  include_tasks:
    file: "single_build_agent.yml"
  vars:
    agent_number_formatted: "{{ '%02d' | format(agent_number) }}"
  loop: "{{ range(1, teamcity_number_of_agents + 1, 1) | list }}"
  loop_control:
    loop_var: agent_number
